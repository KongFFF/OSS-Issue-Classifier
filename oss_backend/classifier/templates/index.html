<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSS Auto-Triage Bot | 智能分拣机器人</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* VSCode 深色主题风格 */
        body { background-color: #1e1e1e; color: #d4d4d4; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background-color: #252526; border-bottom: 1px solid #333; }
        .card { background-color: #252526; border: 1px solid #454545; }
        .form-control { background-color: #3c3c3c; border: 1px solid #3c3c3c; color: #fff; }
        .form-control:focus { background-color: #3c3c3c; color: #fff; border-color: #007acc; box-shadow: none; }
        /* 选项卡样式 */
        .nav-tabs .nav-link { color: #ccc; border: 1px solid transparent; }
        .nav-tabs .nav-link.active { background-color: #252526; color: #007acc; border-color: #454545 #454545 #252526; font-weight: bold; }
        .nav-tabs .nav-link:hover { border-color: #454545; }
        /* 表格样式 */
        .table { color: #d4d4d4; }
        .table-hover tbody tr:hover { color: #fff; background-color: #2a2d2e; }
        /* 徽章样式 */
        .badge-bug { background-color: #ff6b6b; color: #fff; }
        .badge-feature { background-color: #4ec9b0; color: #000; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark mb-4">
        <div class="container">
            <span class="navbar-brand">
                <i class="fa-solid fa-robot me-2 text-primary"></i>
                OSS Auto-Triage Bot
            </span>
            <span class="navbar-text small">Powered by CodeBERT</span>
        </div>
    </nav>

    <div class="container">
        <ul class="nav nav-tabs mb-3" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="scan-tab" data-bs-toggle="tab" data-bs-target="#scan-pane" type="button">
                    <i class="fa-solid fa-radar me-2"></i>Repo Scanner (仓库扫描)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="single-tab" data-bs-toggle="tab" data-bs-target="#single-pane" type="button">
                    <i class="fa-solid fa-file-pen me-2"></i>Single Analysis (单文本)
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="scan-pane">
                <div class="card mb-4">
                    <div class="card-body">
                        <form id="scan-form" class="row g-3">
                            {% csrf_token %} <div class="col-md-9">
                                <div class="input-group">
                                    <span class="input-group-text bg-dark text-light border-secondary">github.com/</span>
                                    <input type="text" class="form-control" id="repo-name" placeholder="user/repo (例如: microsoft/vscode 或 pytorch/pytorch)" value="microsoft/vscode">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100" id="scan-btn">
                                    <i class="fa-solid fa-magnifying-glass me-1"></i> Scan Issues
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="scan-results" style="display: none;">
                    <h5 class="mb-3 text-muted"><i class="fa-solid fa-list-check me-2"></i>Analysis Report</h5>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover border border-secondary align-middle">
                            <thead>
                                <tr class="text-secondary">
                                    <th width="10%">ID</th>
                                    <th width="40%">Issue Title</th>
                                    <th width="15%">Prediction</th>
                                    <th width="10%">Conf.</th>
                                    <th width="25%">Status</th>
                                </tr>
                            </thead>
                            <tbody id="scan-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="single-pane">
                <div class="card">
                    <div class="card-body">
                        <p class="text-muted small mb-2">输入 Issue 描述文本进行分析：</p>
                        <textarea class="form-control mb-3" id="issue-text" rows="6" placeholder="Paste issue description here..."></textarea>
                        <button class="btn btn-secondary w-100" id="analyze-btn">
                            <i class="fa-solid fa-calculator me-1"></i> Analyze Text
                        </button>
                        
                        <div class="mt-4 p-3 border border-secondary rounded bg-dark" id="single-result-box" style="display:none;">
                            <h4 id="single-pred" class="mb-1">--</h4>
                            <div class="progress" style="height: 5px; background-color: #333;">
                                <div class="progress-bar bg-success" id="single-bar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="single-conf">Confidence: 0%</small>
                            
                            <div id="single-similar" class="mt-3" style="display:none;">
                                <h6 class="text-muted border-bottom border-secondary pb-1">Similar Issues:</h6>
                                <ul class="list-unstyled small text-info" id="single-similar-list"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        //功能 1: 仓库扫描 
        document.getElementById('scan-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const repo = document.getElementById('repo-name').value;
            const btn = document.getElementById('scan-btn');
            const tableBody = document.getElementById('scan-table-body');
            const resultArea = document.getElementById('scan-results');

            // UI Loading 状态
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Scanning...';
            tableBody.innerHTML = '';
            resultArea.style.display = 'none';

            fetch('/scan/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrfToken },
                body: `repo_name=${encodeURIComponent(repo)}`
            })
            .then(res => res.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-magnifying-glass me-1"></i> Scan Issues';
                
                if(data.error) { alert("Error: " + data.error); return; }

                data.results.forEach(row => {
                    // 处理重复检测标签
                    let statusHtml = '';
                    if(row.is_duplicate) {
                        statusHtml = `<span class="badge bg-danger" title="Similar to: ${row.duplicate_info}"><i class="fa-solid fa-clone me-1"></i>Duplicate</span>`;
                    } else {
                        statusHtml = `<span class="badge bg-secondary"><i class="fa-solid fa-check me-1"></i>New</span>`;
                    }

                    // 处理分类标签颜色
                    const typeClass = row.type.includes('Bug') ? 'text-danger fw-bold' : 'text-success fw-bold';

                    const tr = `
                        <tr>
                            <td><a href="${row.url}" target="_blank" class="text-decoration-none text-info">#${row.number}</a></td>
                            <td class="text-truncate" style="max-width: 250px;">${row.title}</td>
                            <td class="${typeClass}">${row.type}</td>
                            <td>${row.confidence}</td>
                            <td>${statusHtml}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += tr;
                });
                resultArea.style.display = 'block';
            })
            .catch(err => {
                console.error(err);
                btn.disabled = false;
                alert("Request failed. Check console.");
            });
        });

        // 功能 2: 单文本分析 (保留原有)
        document.getElementById('analyze-btn').addEventListener('click', function() {
            const text = document.getElementById('issue-text').value;
            if(!text) return;

            const btn = this;
            btn.disabled = true;
            btn.innerText = "Analyzing...";

            fetch('/predict/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrfToken },
                body: `text=${encodeURIComponent(text)}`
            })
            .then(res => res.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-calculator me-1"></i> Analyze Text';
                
                if(data.error) { alert(data.error); return; }

                // 显示基本结果
                const box = document.getElementById('single-result-box');
                const label = document.getElementById('single-pred');
                const bar = document.getElementById('single-bar');
                
                box.style.display = 'block';
                label.innerText = data.prediction;
                label.className = data.prediction.includes('Bug') ? 'mb-1 text-danger' : 'mb-1 text-success';
                
                document.getElementById('single-conf').innerText = `Confidence: ${data.confidence}`;
                bar.style.width = data.confidence;
                bar.className = data.prediction.includes('Bug') ? 'progress-bar bg-danger' : 'progress-bar bg-success';

                // 显示相似推荐
                const simList = document.getElementById('single-similar-list');
                const simBox = document.getElementById('single-similar');
                simList.innerHTML = '';
                
                if(data.similar_issues && data.similar_issues.length > 0) {
                    simBox.style.display = 'block';
                    data.similar_issues.forEach(issue => {
                        simList.innerHTML += `<li><a href="${issue.url}" target="_blank" class="text-decoration-none text-info"><i class="fa-regular fa-circle-dot me-1"></i>${issue.title}</a> <span class="text-muted small">(${issue.score})</span></li>`;
                    });
                } else {
                    simBox.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>